name: Publish to PyPI

on:
  push:
    tags:
      - "v*"
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.12"

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write  # Required for trusted publishing (OIDC)
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Extract version from tag
        id: version
        run: |
          # Get version from tag - handle both push (tag) and release events
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          # Remove 'v' prefix from tag if present (e.g., v0.1.0 -> 0.1.0)
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION from tag: $TAG"

      - name: Update package version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" agentform-cli/pyproject.toml
          echo "Updated agentform-cli to version $VERSION"

      - name: Bundle all modules into agentform-cli
        run: |
          echo "Copying module directories into agentform-cli/agentform_cli/..."
          
          # Copy all module directories into agentform_cli
          cp -r agentform-schema/agentform_schema agentform-cli/agentform_cli/
          cp -r agentform-mcp/agentform_mcp agentform-cli/agentform_cli/
          cp -r agentform-compiler/agentform_compiler agentform-cli/agentform_cli/
          cp -r agentform-runtime/agentform_runtime agentform-cli/agentform_cli/
          
          echo "Bundled modules:"
          ls -la agentform-cli/agentform_cli/

      - name: Rewrite imports
        run: |
          echo "Rewriting imports to use agentform_cli.* prefix..."
          
          # Rewrite all imports in Python files
          find agentform-cli/agentform_cli -name "*.py" -type f -exec sed -i \
            -e 's/from agentform_schema/from agentform_cli.agentform_schema/g' \
            -e 's/from agentform_mcp/from agentform_cli.agentform_mcp/g' \
            -e 's/from agentform_compiler/from agentform_cli.agentform_compiler/g' \
            -e 's/from agentform_runtime/from agentform_cli.agentform_runtime/g' \
            -e 's/import agentform_schema/import agentform_cli.agentform_schema as agentform_schema/g' \
            -e 's/import agentform_mcp/import agentform_cli.agentform_mcp as agentform_mcp/g' \
            -e 's/import agentform_compiler/import agentform_cli.agentform_compiler as agentform_compiler/g' \
            -e 's/import agentform_runtime/import agentform_cli.agentform_runtime as agentform_runtime/g' \
            {} \;
          
          echo "Import rewriting complete"

      - name: Remove dev dependencies from pyproject.toml
        run: |
          # Remove the dev dependencies section (path-based deps) before building
          sed -i '/\[tool.poetry.group.dev.dependencies\]/,/^\[/{ /^\[tool.poetry.group.dev.dependencies\]/d; /^\[/!d; }' agentform-cli/pyproject.toml
          
          echo "Final pyproject.toml:"
          cat agentform-cli/pyproject.toml

      - name: Build package
        working-directory: agentform-cli
        run: |
          poetry build
          echo "Built packages:"
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: agentform-cli/dist/
