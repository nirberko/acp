name: Publish to PyPI

on:
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.12"

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write  # Required for trusted publishing (OIDC)
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for poetry-dynamic-versioning

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry and plugins
        run: |
          pip install poetry poetry-dynamic-versioning

      - name: Bundle all modules into acp-cli
        run: |
          echo "Copying module directories into acp-cli/acp_cli/..."
          
          # Copy all module directories into acp_cli
          cp -r acp-schema/acp_schema acp-cli/acp_cli/
          cp -r acp-mcp/acp_mcp acp-cli/acp_cli/
          cp -r acp-compiler/acp_compiler acp-cli/acp_cli/
          cp -r acp-runtime/acp_runtime acp-cli/acp_cli/
          
          echo "Bundled modules:"
          ls -la acp-cli/acp_cli/

      - name: Rewrite imports
        run: |
          echo "Rewriting imports to use acp_cli.* prefix..."
          
          # Rewrite all imports in Python files
          find acp-cli/acp_cli -name "*.py" -type f -exec sed -i \
            -e 's/from acp_schema/from acp_cli.acp_schema/g' \
            -e 's/from acp_mcp/from acp_cli.acp_mcp/g' \
            -e 's/from acp_compiler/from acp_cli.acp_compiler/g' \
            -e 's/from acp_runtime/from acp_cli.acp_runtime/g' \
            -e 's/import acp_schema/import acp_cli.acp_schema as acp_schema/g' \
            -e 's/import acp_mcp/import acp_cli.acp_mcp as acp_mcp/g' \
            -e 's/import acp_compiler/import acp_cli.acp_compiler as acp_compiler/g' \
            -e 's/import acp_runtime/import acp_cli.acp_runtime as acp_runtime/g' \
            {} \;
          
          echo "Import rewriting complete"

      - name: Remove dev dependencies from pyproject.toml
        run: |
          # Remove the dev dependencies section (path-based deps) before building
          sed -i '/\[tool.poetry.group.dev.dependencies\]/,/^\[/{ /^\[tool.poetry.group.dev.dependencies\]/d; /^\[/!d; }' acp-cli/pyproject.toml
          
          echo "Final pyproject.toml:"
          cat acp-cli/pyproject.toml

      - name: Build package
        working-directory: acp-cli
        run: |
          echo "Building with version from git tag: $(git describe --tags)"
          poetry build
          echo "Built packages:"
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: acp-cli/dist/
