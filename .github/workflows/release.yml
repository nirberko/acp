name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Parse version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Creating release for agentform-cli version: $VERSION"

      - name: Verify version in all pyproject.toml files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FAILED=false
          
          # List of all packages to verify
          PACKAGES=(
            "agentform-cli"
            "agentform-compiler"
            "agentform-mcp"
            "agentform-runtime"
            "agentform-schema"
          )
          
          echo "Verifying all packages have version: $VERSION"
          
          for pkg in "${PACKAGES[@]}"; do
            TOML_VERSION=$(grep -Po '(?<=^version = ")[^"]*' "${pkg}/pyproject.toml")
            if [ "$TOML_VERSION" != "$VERSION" ]; then
              echo "❌ ${pkg}: version mismatch (found $TOML_VERSION, expected $VERSION)"
              FAILED=true
            else
              echo "✓ ${pkg}: version $VERSION"
            fi
          done
          
          # Also verify version.py
          VERSION_PY=$(grep -Po '(?<=^VERSION = ")[^"]*' "agentform-schema/agentform_schema/version.py")
          if [ "$VERSION_PY" != "$VERSION" ]; then
            echo "❌ agentform-schema/agentform_schema/version.py: version mismatch (found $VERSION_PY, expected $VERSION)"
            FAILED=true
          else
            echo "✓ agentform-schema/agentform_schema/version.py: version $VERSION"
          fi
          
          if [ "$FAILED" = true ]; then
            echo ""
            echo "Error: Version mismatch detected!"
            echo "All packages must have the same version as the tag."
            exit 1
          fi
          
          echo ""
          echo "All versions verified: $VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: v${{ steps.version.outputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
