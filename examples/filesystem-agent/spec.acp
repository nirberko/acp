// Filesystem Agent Example
// An agent that can read, write, and analyze files using the filesystem MCP server
//
// This example uses the official @modelcontextprotocol/server-filesystem MCP server.
// The server restricts file operations to the specified directory.

acp {
  version = "0.1"
  project = "filesystem-agent"
}

variable "openai_api_key" {
  type        = string
  description = "OpenAI API key"
  sensitive   = true
}

provider "llm.openai" "default" {
  api_key = var.openai_api_key
  default_params {
    temperature = 0.3
    max_tokens  = 4000
  }
}

server "filesystem" {
  type      = "mcp"
  transport = "stdio"
  command   = ["npx", "@modelcontextprotocol/server-filesystem", "/path/to/allowed/directory"]
}

capability "read_file" {
  server      = server.filesystem
  method      = "read_file"
  side_effect = "read"
}

capability "write_file" {
  server           = server.filesystem
  method           = "write_file"
  side_effect      = "write"
  requires_approval = true
}

capability "list_directory" {
  server      = server.filesystem
  method      = "list_directory"
  side_effect = "read"
}

policy "filesystem_policy" {
  budgets { max_cost_usd_per_run = 0.50 }
  budgets { max_capability_calls = 20 }
  budgets { timeout_seconds = 120 }
}

model "gpt4o_mini" {
  provider = provider.llm.openai.default
  id       = "gpt-4o-mini"
  params {
    temperature = 0.3
  }
}

model "gpt4o" {
  provider = provider.llm.openai.default
  id       = "gpt-4o"
}

agent "file_assistant" {
  model           = model.gpt4o_mini
  fallback_models = [model.gpt4o]

  instructions = <<EOF
You are a helpful file assistant. You can read, write, and analyze files.

When working with files:
- Read files to understand their content
- Write files with clear, well-formatted content
- List directories to explore file structure
- Always be careful with file operations

Provide clear summaries of file contents when asked.
EOF

  allow  = [capability.read_file, capability.write_file, capability.list_directory]
  policy = policy.filesystem_policy
}

// Workflow: Read a file and summarize its contents
workflow "read_and_summarize" {
  entry = step.read

  step "read" {
    type       = "call"
    capability = capability.read_file

    args { path = input.file_path }

    output "file_content" { from = result.data }

    next = step.summarize
  }

  step "summarize" {
    type  = "llm"
    agent = agent.file_assistant

    input {
      file_path = input.file_path
      content   = state.file_content
      task      = input.task
    }

    output "summary" { from = result.text }

    next = step.end
  }

  step "end" { type = "end" }
}

// Workflow: Prepare content and write to file
workflow "write_file" {
  entry = step.prepare

  step "prepare" {
    type  = "llm"
    agent = agent.file_assistant

    input {
      file_path    = input.file_path
      instructions = input.instructions
    }

    output "file_data" { from = result.text }

    next = step.write
  }

  step "write" {
    type       = "call"
    capability = capability.write_file

    args {
      path     = input.file_path
      contents = state.file_data
    }

    output "result" { from = result.data }

    next = step.end
  }

  step "end" { type = "end" }
}

// Workflow: List directory and analyze contents
workflow "list_and_read" {
  entry = step.list

  step "list" {
    type       = "call"
    capability = capability.list_directory

    args { path = input.directory_path }

    output "directory_contents" { from = result.data }

    next = step.analyze
  }

  step "analyze" {
    type  = "llm"
    agent = agent.file_assistant

    input {
      directory_path = input.directory_path
      files          = state.directory_contents
      task           = input.task
    }

    output "analysis" { from = result.text }

    next = step.end
  }

  step "end" { type = "end" }
}

