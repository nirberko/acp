# PR Reviewer Example
# An agent that reviews pull requests using GitHub MCP server

version: "0.1"

project:
  name: pr-reviewer

providers:
  llm:
    openai:
      api_key: env:OPENAI_API_KEY
      default_params:
        temperature: 0.3
        max_tokens: 4000

servers:
  - name: github
    type: mcp
    transport: stdio
    command:
      - npx
      - "@modelcontextprotocol/server-github"
    auth:
      token: env:GITHUB_PERSONAL_ACCESS_TOKEN

capabilities:
  - name: get_pr
    server: github
    method: get_pull_request
    side_effect: read

  - name: list_pr_files
    server: github
    method: get_pull_request_files
    side_effect: read

  - name: create_review
    server: github
    method: create_pull_request_review
    side_effect: write
    requires_approval: true

policies:
  - name: review_policy
    budgets:
      max_cost_usd_per_run: 1.00
      max_capability_calls: 10
      timeout_seconds: 300

agents:
  - name: reviewer
    provider: openai
    model:
      preference: gpt-4o
    params:
      temperature: 0.2
    instructions: |
      You are an expert code reviewer. Review pull requests thoroughly.
      
      Focus on:
      - Code quality and best practices
      - Potential bugs or edge cases
      - Performance implications
      - Security concerns
      - Documentation and readability
      
      Be constructive and specific in your feedback.
      Suggest improvements where possible.
    allow:
      - get_pr
      - list_pr_files
      - create_review
    policy: review_policy

workflows:
  - name: review_pr
    entry: fetch_pr
    steps:
      - id: fetch_pr
        type: call
        capability: get_pr
        args:
          owner: $input.owner
          repo: $input.repo
          pull_number: $input.pr_number
        save_as: pr_data
        next: fetch_files

      - id: fetch_files
        type: call
        capability: list_pr_files
        args:
          owner: $input.owner
          repo: $input.repo
          pull_number: $input.pr_number
        save_as: pr_files
        next: analyze

      - id: analyze
        type: llm
        agent: reviewer
        input:
          pr: $state.pr_data
          files: $state.pr_files
        save_as: review
        next: approval

      - id: approval
        type: human_approval
        payload: $state.review
        on_approve: submit_review
        on_reject: end

      - id: submit_review
        type: call
        capability: create_review
        args:
          owner: $input.owner
          repo: $input.repo
          pull_number: $input.pr_number
          body: $state.review.response
          event: COMMENT
        save_as: result
        next: end

      - id: end
        type: end

